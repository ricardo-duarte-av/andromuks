package net.vrkknn.andromuks.utils

import android.os.Build
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.GridItemSpan
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.items
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.*
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.Search
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.asImageBitmap
import androidx.compose.ui.graphics.painter.Painter
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.window.Dialog
import androidx.compose.ui.window.DialogProperties
import coil.compose.AsyncImage
import coil.decode.GifDecoder
import coil.decode.ImageDecoderDecoder
import coil.request.ImageRequest
import coil.request.CachePolicy
import coil.ImageLoader
import net.vrkknn.andromuks.utils.MediaUtils

/**
 * Displays an image emoji in the emoji selection grid using Coil (supports GIFs).
 * 
 * @param mxcUrl The MXC URL for the emoji image
 * @param homeserverUrl The homeserver URL for MXC conversion
 * @param authToken The authentication token for MXC URL downloads
 */
@Composable
fun ImageEmoji(
    mxcUrl: String,
    homeserverUrl: String,
    authToken: String
) {
    val context = LocalContext.current
    
    android.util.Log.d("Andromuks", "ImageEmoji: Starting to load emoji from MXC URL: $mxcUrl")
    
    // Convert MXC URL to HTTP URL
    val httpUrl = remember(mxcUrl, homeserverUrl) {
        MediaUtils.mxcToHttpUrl(mxcUrl, homeserverUrl)
    }
    
    // Use shared ImageLoader singleton with custom User-Agent
    val imageLoader = remember { ImageLoaderSingleton.get(context) }
    
    android.util.Log.d("Andromuks", "ImageEmoji: Converted HTTP URL: $httpUrl")
    
    if (httpUrl != null) {
        AsyncImage(
            model = ImageRequest.Builder(context)
                .data(httpUrl)
                .addHeader("Cookie", "gomuks_auth=$authToken")
                .memoryCachePolicy(CachePolicy.ENABLED)
                .diskCachePolicy(CachePolicy.ENABLED)
                .build(),
            imageLoader = imageLoader,
            contentDescription = "Emoji",
            modifier = Modifier
                .size(32.dp)
                .clip(RoundedCornerShape(6.dp)),
            contentScale = ContentScale.Crop,
            onSuccess = {
                android.util.Log.d("Andromuks", "ImageEmoji: Successfully loaded emoji for $mxcUrl")
            },
            onError = { state ->
                if (state is coil.request.ErrorResult) {
                    CacheUtils.handleImageLoadError(
                        imageUrl = httpUrl,
                        throwable = state.throwable,
                        imageLoader = imageLoader,
                        context = "Emoji"
                    )
                }
            }
        )
    } else {
        android.util.Log.e("Andromuks", "ImageEmoji: Failed to convert MXC URL to HTTP URL: $mxcUrl")
        Text(
            text = "‚ùå",
            style = MaterialTheme.typography.headlineSmall
        )
    }
}

/**
 * Emoji selection dialog with categories and recent emojis
 */
@Composable
fun EmojiSelectionDialog(
    recentEmojis: List<String>,
    homeserverUrl: String,
    authToken: String,
    onEmojiSelected: (String) -> Unit,
    onDismiss: () -> Unit
) {
    var selectedCategory by remember { mutableStateOf(0) }
    var searchText by remember { mutableStateOf("") }
    
    Dialog(
        onDismissRequest = onDismiss,
        properties = DialogProperties(
            dismissOnBackPress = true,
            dismissOnClickOutside = true
        )
    ) {
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .height(400.dp),
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surface
            ),
            elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)
        ) {
            Column(
                modifier = Modifier.fillMaxSize()
            ) {
                // Category tabs
                LazyRow(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(8.dp),
                    horizontalArrangement = Arrangement.spacedBy(4.dp)
                ) {
                    items(emojiCategories.size) { index ->
                        val category = emojiCategories[index]
                        Surface(
                            modifier = Modifier
                                .clip(RoundedCornerShape(8.dp))
                                .clickable { selectedCategory = index },
                            color = if (selectedCategory == index) 
                                MaterialTheme.colorScheme.primary 
                            else 
                                MaterialTheme.colorScheme.surfaceVariant
                        ) {
                            Text(
                                text = category.icon,
                                modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp),
                                style = MaterialTheme.typography.titleMedium,
                                color = if (selectedCategory == index) 
                                    MaterialTheme.colorScheme.onPrimary 
                                else 
                                    MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        }
                    }
                }
                
                // Search box
                OutlinedTextField(
                    value = searchText,
                    onValueChange = { searchText = it },
                    placeholder = { Text("Search emojis or type custom reaction...") },
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 8.dp),
                    singleLine = true,
                    leadingIcon = {
                        Icon(
                            imageVector = Icons.Default.Search,
                            contentDescription = "Search"
                        )
                    }
                )
                
                // Emoji grid
                LazyVerticalGrid(
                    columns = GridCells.Fixed(8),
                    modifier = Modifier
                        .fillMaxWidth()
                        .weight(1f)
                        .padding(8.dp),
                    verticalArrangement = Arrangement.spacedBy(4.dp),
                    horizontalArrangement = Arrangement.spacedBy(4.dp)
                ) {
                    val baseEmojis = if (selectedCategory == 0) {
                        recentEmojis
                    } else {
                        emojiCategories[selectedCategory].emojis
                    }
                    
                    // Filter emojis based on search text
                    val filteredEmojis = if (searchText.isBlank()) {
                        baseEmojis
                    } else {
                        baseEmojis.filter { it.contains(searchText, ignoreCase = true) }
                    }
                    
                    items(filteredEmojis) { emoji ->
                        Surface(
                            modifier = Modifier
                                .size(40.dp)
                                .clip(RoundedCornerShape(8.dp))
                                .clickable { 
                                    onEmojiSelected(emoji)
                                    onDismiss()
                                },
                            color = Color.Transparent
                        ) {
                            Box(
                                modifier = Modifier.fillMaxSize(),
                                contentAlignment = Alignment.Center
                            ) {
                                if (emoji.startsWith("mxc://")) {
                                    // Handle image reactions in recent tab
                                    ImageEmoji(emoji, homeserverUrl, authToken)
                                } else {
                                    // Handle regular emojis
                                    Text(
                                        text = emoji,
                                        style = MaterialTheme.typography.headlineSmall
                                    )
                                }
                            }
                        }
                    }
                    
                    // Custom reaction button if search text is not empty and not found in emojis
                    if (searchText.isNotBlank() && !baseEmojis.any { it.contains(searchText, ignoreCase = true) }) {
                        item(span = { GridItemSpan(8) }) {
                            Button(
                                onClick = { 
                                    onEmojiSelected(searchText)
                                    onDismiss()
                                },
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .padding(8.dp)
                            ) {
                                Text("React with \"$searchText\"")
                            }
                        }
                    }
                }
            }
        }
    }
}

// Emoji categories data
private val emojiCategories = listOf(
    EmojiCategory("üïí", "Recent", listOf()),
    EmojiCategory("üòÄ", "Smileys", listOf("üòÄ", "üòÉ", "üòÑ", "üòÅ", "üòÜ", "üòÖ", "ü§£", "üòÇ", "üôÇ", "üôÉ", "üòâ", "üòä", "üòá", "ü•∞", "üòç", "ü§©", "üòò", "üòó", "üòö", "üòô", "üòã", "üòõ", "üòú", "ü§™", "üòù", "ü§ë", "ü§ó", "ü§≠", "ü§´", "ü§î", "ü§ê", "ü§®", "üòê", "üòë", "üò∂", "üòè", "üòí", "üôÑ", "üò¨", "ü§•", "üòî", "üò™", "ü§§", "üò¥", "üò∑", "ü§í", "ü§ï", "ü§¢", "ü§Æ", "ü§ß", "ü•µ", "ü•∂", "ü•¥", "üòµ", "ü§Ø", "ü§†", "ü•≥", "üòé", "ü§ì", "üßê")),
    EmojiCategory("üë•", "People", listOf("üë∂", "üßí", "üë¶", "üëß", "üßë", "üë®", "üë©", "üßì", "üë¥", "üëµ", "üë§", "üë•", "ü´Ç", "üë™", "üë®‚Äçüë©‚Äçüëß", "üë®‚Äçüë©‚Äçüëß‚Äçüë¶", "üë®‚Äçüë©‚Äçüë¶‚Äçüë¶", "üë®‚Äçüë©‚Äçüëß‚Äçüëß", "üë®‚Äçüë®‚Äçüë¶", "üë®‚Äçüë®‚Äçüëß", "üë®‚Äçüë®‚Äçüëß‚Äçüë¶", "üë®‚Äçüë®‚Äçüë¶‚Äçüë¶", "üë®‚Äçüë®‚Äçüëß‚Äçüëß", "üë©‚Äçüë©‚Äçüë¶", "üë©‚Äçüë©‚Äçüëß", "üë©‚Äçüë©‚Äçüëß‚Äçüë¶", "üë©‚Äçüë©‚Äçüë¶‚Äçüë¶", "üë©‚Äçüë©‚Äçüëß‚Äçüëß", "üë®‚Äçüë¶", "üë®‚Äçüë¶‚Äçüë¶", "üë®‚Äçüëß", "üë®‚Äçüëß‚Äçüë¶", "üë®‚Äçüëß‚Äçüëß", "üë©‚Äçüë¶", "üë©‚Äçüë¶‚Äçüë¶", "üë©‚Äçüëß", "üë©‚Äçüëß‚Äçüë¶", "üë©‚Äçüëß‚Äçüëß")),
    EmojiCategory("üê∂", "Animals", listOf("üê∂", "üê±", "üê≠", "üêπ", "üê∞", "ü¶ä", "üêª", "üêº", "üê®", "üêØ", "ü¶Å", "üêÆ", "üê∑", "üê∏", "üêµ", "üôà", "üôâ", "üôä", "üêí", "üêî", "üêß", "üê¶", "üê§", "üê£", "üê•", "ü¶Ü", "ü¶Ö", "ü¶â", "ü¶á", "üê∫", "üêó", "üê¥", "ü¶Ñ", "üêù", "üêõ", "ü¶ã", "üêå", "üêû", "üêú", "ü¶ü", "ü¶ó", "üï∑", "üï∏", "ü¶Ç", "üê¢", "üêç", "ü¶é", "ü¶ñ", "ü¶ï", "üêô", "ü¶ë", "ü¶ê", "ü¶û", "ü¶Ä", "üê°", "üê†", "üêü", "üê¨", "üê≥", "üêã", "ü¶à", "üêä", "üêÖ", "üêÜ", "ü¶ì", "ü¶ç", "ü¶ß", "üêò", "ü¶õ", "ü¶è", "üê™", "üê´", "ü¶í", "ü¶ò", "üêÉ", "üêÇ", "üêÑ", "üêé", "üêñ", "üêè", "üêë", "ü¶ô", "üêê", "ü¶å", "üêï", "üê©", "ü¶Æ", "üêï‚Äçü¶∫", "üêà", "üêì", "ü¶É", "ü¶ö", "ü¶ú", "ü¶¢", "ü¶©", "üïä", "üêá", "ü¶ù", "ü¶®", "ü¶°", "ü¶¶", "ü¶•", "üêÅ", "üêÄ", "üêø", "ü¶î")),
    EmojiCategory("üçé", "Food", listOf("üçé", "üçê", "üçä", "üçã", "üçå", "üçâ", "üçá", "üçì", "ü´ê", "üçà", "üçí", "üçë", "ü•≠", "üçç", "ü••", "ü•ù", "üçÖ", "üçÜ", "ü•ë", "ü•¶", "ü•¨", "ü•í", "üå∂", "ü´ë", "üåΩ", "ü•ï", "ü´í", "üßÑ", "üßÖ", "ü•î", "üç†", "ü•ê", "ü•ñ", "üçû", "ü•®", "ü•Ø", "üßÄ", "ü•ö", "üç≥", "üßà", "ü•û", "üßá", "ü•ì", "ü•©", "üçó", "üçñ", "ü¶¥", "üå≠", "üçî", "üçü", "üçï", "ü´ì", "ü•ô", "üåÆ", "üåØ", "ü´î", "ü•ó", "ü•ò", "ü´ï", "ü•´", "üçù", "üçú", "üç≤", "üçõ", "üç£", "üç±", "ü•ü", "ü¶™", "üç§", "üçô", "üçö", "üçò", "üç•", "ü•†", "ü•Æ", "üç¢", "üç°", "üçß", "üç®", "üç¶", "ü•ß", "üßÅ", "üç∞", "üéÇ", "üçÆ", "üç≠", "üç¨", "üç´", "üçø", "üç©", "üç™", "üå∞", "ü•ú", "üçØ")),
    EmojiCategory("‚öΩ", "Activities", listOf("‚öΩ", "üèÄ", "üèà", "‚öæ", "ü•é", "üéæ", "üèê", "üèâ", "ü•è", "üé±", "ü™Ä", "üèì", "üè∏", "üèí", "üèë", "ü•ç", "üèè", "ü™É", "ü•Ö", "‚õ≥", "ü™Å", "üèπ", "üé£", "ü§ø", "ü•ä", "ü•ã", "üéΩ", "üõπ", "üõ∑", "‚õ∏", "ü•å", "üéø", "‚õ∑", "üèÇ", "ü™Ç", "üèãÔ∏è‚Äç‚ôÄÔ∏è", "üèãÔ∏è", "üèãÔ∏è‚Äç‚ôÇÔ∏è", "ü§º‚Äç‚ôÄÔ∏è", "ü§º", "ü§º‚Äç‚ôÇÔ∏è", "ü§∏‚Äç‚ôÄÔ∏è", "ü§∏", "ü§∏‚Äç‚ôÇÔ∏è", "‚õπÔ∏è‚Äç‚ôÄÔ∏è", "‚õπÔ∏è", "‚õπÔ∏è‚Äç‚ôÇÔ∏è", "ü§∫", "ü§æ‚Äç‚ôÄÔ∏è", "ü§æ", "ü§æ‚Äç‚ôÇÔ∏è", "üèåÔ∏è‚Äç‚ôÄÔ∏è", "üèåÔ∏è", "üèåÔ∏è‚Äç‚ôÇÔ∏è", "üèá", "üßò‚Äç‚ôÄÔ∏è", "üßò", "üßò‚Äç‚ôÇÔ∏è", "üèÑ‚Äç‚ôÄÔ∏è", "üèÑ", "üèÑ‚Äç‚ôÇÔ∏è", "üèä‚Äç‚ôÄÔ∏è", "üèä", "üèä‚Äç‚ôÇÔ∏è", "ü§Ω‚Äç‚ôÄÔ∏è", "ü§Ω", "ü§Ω‚Äç‚ôÇÔ∏è", "üö£‚Äç‚ôÄÔ∏è", "üö£", "üö£‚Äç‚ôÇÔ∏è", "üßó‚Äç‚ôÄÔ∏è", "üßó", "üßó‚Äç‚ôÇÔ∏è", "üöµ‚Äç‚ôÄÔ∏è", "üöµ", "üöµ‚Äç‚ôÇÔ∏è", "üö¥‚Äç‚ôÄÔ∏è", "üö¥", "üö¥‚Äç‚ôÇÔ∏è", "üèÜ", "ü•á", "ü•à", "ü•â", "üèÖ", "üéñ", "üèµ", "üéó", "üé´", "üéü", "üé™", "ü§π", "ü§π‚Äç‚ôÇÔ∏è", "ü§π‚Äç‚ôÄÔ∏è", "üé≠", "ü©∞", "üé®", "üé¨", "üé§", "üéß", "üéº", "üéµ", "üé∂", "ü•Å", "ü™ò", "üéπ", "üé∑", "üé∫", "ü™ó", "üé∏", "ü™ï", "üéª")),
    EmojiCategory("üì±", "Objects", listOf("‚åö", "üì±", "üì≤", "üíª", "‚å®Ô∏è", "üñ•", "üñ®", "üñ±", "üñ≤", "üïπ", "üóú", "üíΩ", "üíæ", "üíø", "üìÄ", "üìº", "üì∑", "üì∏", "üìπ", "üé•", "üìΩ", "üéû", "üìû", "‚òéÔ∏è", "üìü", "üì†", "üì∫", "üìª", "üéô", "üéö", "üéõ", "üß≠", "‚è±", "‚è≤", "‚è∞", "üï∞", "‚åõ", "‚è≥", "üì°", "üîã", "üîå", "üí°", "üî¶", "üïØ", "ü™î", "üßØ", "üõ¢", "üí∏", "üíµ", "üí¥", "üí∂", "üí∑", "üí∞", "üí≥", "üíé", "‚öñÔ∏è", "üß∞", "üîß", "üî®", "‚öí", "üõ†", "‚õè", "üî©", "‚öôÔ∏è", "üß±", "‚õì", "üß≤", "üî´", "üí£", "üß®", "ü™ì", "üî™", "üó°", "‚öîÔ∏è", "üõ°", "üö¨", "‚ö∞Ô∏è", "ü™¶", "‚ö±Ô∏è", "üè∫", "üîÆ", "üìø", "üßø", "üíà", "‚öóÔ∏è", "üî≠", "üî¨", "üï≥", "ü©π", "ü©∫", "üíä", "üíâ", "üß¨", "ü¶†", "üß´", "üß™", "üå°", "üßπ", "üß∫", "üßª", "üöΩ", "üö∞", "üöø", "üõÅ", "üõÄ", "üßº", "ü™í", "üßΩ", "üß¥", "üõé", "üîë", "üóù", "üö™", "ü™ë", "üõã", "üõè", "üõå", "üß∏", "üñº", "üõç", "üõí", "üéÅ", "üéà", "üéè", "üéÄ", "üéä", "üéâ", "üéé", "üèÆ", "üéê", "üßß", "‚úâÔ∏è", "üì©", "üì®", "üìß", "üíå", "üì•", "üì§", "üì¶", "üè∑", "üì™", "üì´", "üì¨", "üì≠", "üìÆ", "üó≥", "‚úèÔ∏è", "‚úíÔ∏è", "üñã", "üñä", "üñå", "üñç", "üìù", "üíº", "üìÅ", "üìÇ", "üóÇ", "üìÖ", "üìÜ", "üóí", "üóì", "üìá", "üìà", "üìâ", "üìä", "üìã", "üìå", "üìç", "üìé", "üñá", "üìè", "üìê", "‚úÇÔ∏è", "üóÉ", "üóÑ", "üóë", "üîí", "üîì", "üîè", "üîê", "üîë", "üóù", "üî®", "‚õè", "‚öí", "üõ†", "üó°", "‚öîÔ∏è", "üî´", "üèπ", "üõ°", "üîß", "üî©", "‚öôÔ∏è", "üß∞", "‚öñÔ∏è", "üîó", "‚õì", "üß≤", "üî´", "üí£", "üß®", "ü™ì", "üî™", "üó°", "‚öîÔ∏è", "üõ°", "üö¨", "‚ö∞Ô∏è", "ü™¶", "‚ö±Ô∏è", "üè∫", "üîÆ", "üìø", "üßø", "üíà", "‚öóÔ∏è", "üî≠", "üî¨", "üï≥", "ü©π", "ü©∫", "üíä", "üíâ", "üß¨", "ü¶†", "üß´", "üß™", "üå°", "üßπ", "üß∫", "üßª", "üöΩ", "üö∞", "üöø", "üõÅ", "üõÄ", "üßº", "ü™í", "üßΩ", "üß¥", "üõé", "üîë", "üóù", "üö™", "ü™ë", "üõã", "üõè", "üõå", "üß∏", "üñº", "üõç", "üõí", "üéÅ", "üéà", "üéè", "üéÄ", "üéä", "üéâ", "üéé", "üèÆ", "üéê", "üßß")),
    EmojiCategory("‚ù§Ô∏è", "Symbols", listOf("‚ù§Ô∏è", "üß°", "üíõ", "üíö", "üíô", "üíú", "üñ§", "ü§ç", "ü§é", "üíî", "‚ù£Ô∏è", "üíï", "üíû", "üíì", "üíó", "üíñ", "üíò", "üíù", "üíü", "‚òÆÔ∏è", "‚úùÔ∏è", "‚ò™Ô∏è", "üïâ", "‚ò∏Ô∏è", "‚ú°Ô∏è", "üîØ", "üïé", "‚òØÔ∏è", "‚ò¶Ô∏è", "üõê", "‚õé", "‚ôà", "‚ôâ", "‚ôä", "‚ôã", "‚ôå", "‚ôç", "‚ôé", "‚ôè", "‚ôê", "‚ôë", "‚ôí", "‚ôì", "üÜî", "‚öõÔ∏è", "üâë", "‚ò¢Ô∏è", "‚ò£Ô∏è", "üì¥", "üì≥", "üà∂", "üàö", "üà∏", "üà∫", "üà∑Ô∏è", "‚ú¥Ô∏è", "üÜö", "üíÆ", "üâê", "„äôÔ∏è", "„äóÔ∏è", "üà¥", "üàµ", "üàπ", "üà≤", "üÖ∞Ô∏è", "üÖ±Ô∏è", "üÜé", "üÜë", "üÖæÔ∏è", "üÜò", "‚ùå", "‚≠ï", "üõë", "‚õî", "üìõ", "üö´", "üíØ", "üí¢", "‚ô®Ô∏è", "üö∑", "üöØ", "üö≥", "üö±", "üîû", "üìµ", "üö≠", "‚ùó", "‚ùï", "‚ùì", "‚ùî", "‚ÄºÔ∏è", "‚ÅâÔ∏è", "üîÖ", "üîÜ", "„ÄΩÔ∏è", "‚ö†Ô∏è", "üö∏", "üî±", "‚öúÔ∏è", "üî∞", "‚ôªÔ∏è", "‚úÖ", "üàØ", "üíπ", "‚ùáÔ∏è", "‚ú≥Ô∏è", "‚ùé", "üåê", "üí†", "‚ìÇÔ∏è", "üåÄ", "üí§", "üèß", "üöæ", "‚ôø", "üÖøÔ∏è", "üà≥", "üàÇÔ∏è", "üõÇ", "üõÉ", "üõÑ", "üõÖ", "üöπ", "üö∫", "üöº", "‚öß", "üöª", "üöÆ", "üé¶", "üì∂", "üàÅ", "üî£", "‚ÑπÔ∏è", "üî§", "üî°", "üî†", "üÜñ", "üÜó", "üÜô", "üÜí", "üÜï", "üÜì", "0Ô∏è‚É£", "1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£", "9Ô∏è‚É£", "üîü"))
)

data class EmojiCategory(
    val icon: String,
    val name: String,
    val emojis: List<String>
)
